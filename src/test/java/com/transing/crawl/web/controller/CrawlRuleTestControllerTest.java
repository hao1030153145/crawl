package com.transing.crawl.web.controller;

import com.jeeframework.testframework.AbstractSpringBaseControllerTest;
import com.jeeframework.util.httpclient.HttpClientHelper;
import com.transing.crawl.util.CharsetUtils;
import com.transing.crawl.util.client.HttpResponse;
import org.junit.Test;
import org.springframework.test.web.servlet.MvcResult;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;

import java.util.HashMap;
import java.util.Map;

import static org.junit.Assert.assertTrue;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

public class CrawlRuleTestControllerTest extends
        AbstractSpringBaseControllerTest {

    @Test
    public void fieldRuleTest() throws Exception{
        String URI="/crawlRule/testDetailRuleFieldProcessor.json";
        MvcResult mvcResult=this.mockMvc.perform(MockMvcRequestBuilders.post(URI)
                .param("testInLogin","no")
                .param("testUrl", "http://money.163.com/special/00251LR5/cpznList.html")
                .param("param","")
                .param("headers","[]")
                .param("crawlMethod","GET")
                .param("requestEncoding","GBK")
                .param("responseEncoding","GBK")
                .param("detailPreProc","[]")
                .param("detailParse","[{\"crawlRuleDetailId\":123,\"createTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"id\":60,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"parseExpression\":\"//div[@class='item_top']\",\"parseType\":\"1\",\"$$hashKey\":\"object:18\"}]")
                .param("detailSuffProc","[]")
                .param("pageType","1")
                .param("field","[{\"crawlRuleDetailId\":123,\"id\":798,\"isNull\":\"0\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":16,\"fieldEnName\":\"title\",\"fieldDesc\":\"列表标题\",\"fieldLength\":40,\"fieldCnName\":\"列表标题\",\"fieldTypeName\":\"text\",\"fieldParse\":[{\"createTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"detailFieldId\":798,\"id\":420,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"parseExpression\":\"//h2/a\",\"parseType\":\"1\",\"$$hashKey\":\"object:24\"}],\"fieldSuffProc\":[],\"$$hashKey\":\"object:4\",\"storageTypeFieldBo\":{\"createTime\":{\"date\":26,\"day\":2,\"hours\":23,\"minutes\":26,\"month\":8,\"seconds\":50,\"time\":1506439610000,\"timezoneOffset\":-480,\"year\":117},\"decimalLength\":0,\"fieldCnName\":\"列表标题\",\"fieldDesc\":\"列表标题\",\"fieldEnName\":\"title\",\"fieldLength\":40,\"fieldType\":\"text\",\"id\":16,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":18,\"minutes\":13,\"month\":8,\"seconds\":4,\"time\":1536055984000,\"timezoneOffset\":-480,\"year\":118},\"storageTypeId\":9}},{\"crawlRuleDetailId\":123,\"id\":799,\"isNull\":\"0\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":17,\"fieldEnName\":\"url\",\"fieldDesc\":\"网站链接\",\"fieldLength\":200,\"fieldCnName\":\"网站链接\",\"fieldTypeName\":\"text\",\"fieldParse\":[{\"createTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"detailFieldId\":799,\"id\":424,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"parseExpression\":\"//a/@href\",\"parseType\":\"1\",\"$$hashKey\":\"object:31\"}],\"fieldSuffProc\":[],\"$$hashKey\":\"object:5\"},{\"crawlRuleDetailId\":123,\"id\":800,\"isNull\":\"1\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":18,\"fieldEnName\":\"summary\",\"fieldDesc\":\"内容摘要\",\"fieldLength\":200,\"fieldCnName\":\"内容摘要\",\"fieldTypeName\":\"text\",\"fieldParse\":[],\"fieldSuffProc\":[],\"$$hashKey\":\"object:6\"},{\"crawlRuleDetailId\":123,\"id\":801,\"isNull\":\"1\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":19,\"fieldEnName\":\"publishtime\",\"fieldDesc\":\"发布时间\",\"fieldLength\":40,\"fieldCnName\":\"发布时间\",\"fieldTypeName\":\"datetime\",\"fieldParse\":[{\"createTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"detailFieldId\":801,\"id\":425,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":15,\"minutes\":21,\"month\":8,\"seconds\":41,\"time\":1536045701000,\"timezoneOffset\":-480,\"year\":118},\"parseExpression\":\"//p/span[@class=&apos;time&apos;]\",\"parseType\":\"1\",\"$$hashKey\":\"object:35\"}],\"fieldSuffProc\":[],\"$$hashKey\":\"object:7\"},{\"crawlRuleDetailId\":123,\"id\":802,\"isNull\":\"1\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":29,\"fieldEnName\":\"content\",\"fieldDesc\":\"内容\",\"fieldLength\":10000,\"fieldCnName\":\"内容\",\"fieldTypeName\":\"text\",\"fieldParse\":[],\"fieldSuffProc\":[],\"$$hashKey\":\"object:8\"},{\"crawlRuleDetailId\":123,\"id\":803,\"isNull\":\"1\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":46,\"fieldEnName\":\"author\",\"fieldDesc\":\"作者\",\"fieldLength\":255,\"fieldCnName\":\"作者\",\"fieldTypeName\":\"text\",\"fieldParse\":[],\"fieldSuffProc\":[],\"$$hashKey\":\"object:9\"},{\"crawlRuleDetailId\":123,\"id\":804,\"isNull\":\"1\",\"isUnique\":\"0\",\"ruleId\":177,\"storageTypeFieldId\":47,\"fieldEnName\":\"source\",\"fieldDesc\":\"来源\",\"fieldLength\":255,\"fieldCnName\":\"来源\",\"fieldTypeName\":\"text\",\"fieldParse\":[],\"fieldSuffProc\":[],\"$$hashKey\":\"object:10\"}]")
                .param("datasourceId","88"))
                .andDo(print()).andExpect(status().isOk()).andReturn();
        String content=mvcResult.getResponse().getContentAsString();
        assertTrue(com.jeeframework.util.json.JSONUtils.isJSONValid(content));
    }

    @Test
    public void crawlRuleDetailRuleFieldProcessorTest() throws Exception {
        String URI = "/crawlRule/testDetailRuleListProcessor.json";
        MvcResult mvcResult = this.mockMvc.perform(MockMvcRequestBuilders.post(URI)
                .param("testInLogin", "no")
                .param("testUrl", "http://www.bsgxw.gov.cn/list-14-1.html")
                //.param("testUrl","http://www.cn-em.com/news/?2977.htm")
                //.param("testUrl","file:///C:/Users/Administrator/Desktop/%E6%96%B0%E5%BB%BA%E6%96%87%E6%9C%AC%E6%96%87%E6%A1%A3%20(5).html")
                .param("param", "")
                //.param("headers", "[{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Cookie\",\"headerType\":2,\"headerValue\":\"__cfduid=d47fe83d6ca7175a19d2e23a09b85c0e01536052060; yunsuo_session_verify=096436fbc935c4dff90f8194a1bba61f; srcurl=687474703a2f2f7777772e62736778772e676f762e636e2f6c6973742d31342d312e68746d6c; security_session_mid_verify=4eb90f3ca4d8ab936c9dd1cf96ad10ee; yjs_id=cf6278d9dc34747b543ea70a324f4dc0; ctrl_time=1\",\"id\":18,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Connection\",\"headerType\":1,\"headerValue\":\"keep-alive\",\"id\":19,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"User-Agent\",\"headerType\":1,\"headerValue\":\"User-Agent\",\"id\":20,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept\",\"headerType\":1,\"headerValue\":\"text/html, application/xhtml+xml, */*\",\"id\":21,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept-Encoding\",\"headerType\":1,\"headerValue\":\"gzip, deflate\",\"id\":22,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept-Language\",\"headerType\":1,\"headerValue\":\"zh-CN\",\"id\":23,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Host\",\"headerType\":1,\"headerValue\":\"www.bsgxw.gov.cn\",\"id\":24,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Referer\",\"headerType\":1,\"headerValue\":\"http://www.bsgxw.gov.cn/list-14-1.html?security_verify_data=313932302c31303830\",\"id\":25,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]}]")
                .param("headParameters","[{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Cookie\",\"headerType\":2,\"headerValue\":\"__cfduid=d47fe83d6ca7175a19d2e23a09b85c0e01536052060; yunsuo_session_verify=096436fbc935c4dff90f8194a1bba61f;srcurl=687474703a2f2f7777772e62736778772e676f762e636e2f6c6973742d31342d312e68746d6c;yjs_id=cf6278d9dc34747b543ea70a324f4dc0; ctrl_time=1\",\"id\":18,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Connection\",\"headerType\":1,\"headerValue\":\"keep-alive\",\"id\":19,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"User-Agent\",\"headerType\":1,\"headerValue\":\"User-Agent\",\"id\":20,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept\",\"headerType\":1,\"headerValue\":\"text/html, application/xhtml+xml, */*\",\"id\":21,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept-Encoding\",\"headerType\":1,\"headerValue\":\"gzip, deflate\",\"id\":22,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Accept-Language\",\"headerType\":1,\"headerValue\":\"zh-CN\",\"id\":23,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Host\",\"headerType\":1,\"headerValue\":\"www.bsgxw.gov.cn\",\"id\":24,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]},{\"crawlRuleId\":180,\"createTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerName\":\"Referer\",\"headerType\":1,\"headerValue\":\"http://www.bsgxw.gov.cn/list-14-1.html?security_verify_data=313932302c31303830\",\"id\":25,\"inputType\":1,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":17,\"minutes\":59,\"month\":8,\"seconds\":57,\"time\":1536055197000,\"timezoneOffset\":-480,\"year\":118},\"headerSufferProc\":[]}]")
                //.param("headParameters","[]")
                .param("crawlMethod", "GET")
                .param("requestEncoding", "UTF-8")
                .param("responseEncoding", "UTF-8")
                .param("detailPreProc", "[]")
                .param("detailParse", "[{\"crawlRuleDetailId\":129,\"createTime\":{\"date\":4,\"day\":2,\"hours\":18,\"minutes\":34,\"month\":8,\"seconds\":52,\"time\":1536057292000,\"timezoneOffset\":-480,\"year\":118},\"id\":65,\"lastmodifyTime\":{\"date\":4,\"day\":2,\"hours\":18,\"minutes\":34,\"month\":8,\"seconds\":52,\"time\":1536057292000,\"timezoneOffset\":-480,\"year\":118},\"parseExpression\":\"(.*)\",\"parseType\":\"2\",\"$$hashKey\":\"object:18\"}]")
                .param("detailSuffProc", "[]")
                .param("pageType", "1")
                .param("datasourceId", "85"))
                .andDo(print()).andExpect(status().isOk()).andReturn();
        String content = mvcResult.getResponse().getContentAsString();
        assertTrue(com.jeeframework.util.json.JSONUtils.isJSONValid(content));

    }


}
