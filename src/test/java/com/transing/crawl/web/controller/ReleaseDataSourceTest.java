package com.transing.crawl.web.controller;

import com.jeeframework.testframework.AbstractSpringBaseControllerTest;
import net.sf.json.JSONObject;
import org.junit.Test;
import org.springframework.test.web.servlet.MvcResult;
import org.springframework.test.web.servlet.request.MockMvcRequestBuilders;

import static org.junit.Assert.assertTrue;
import static org.springframework.test.web.servlet.result.MockMvcResultHandlers.print;
import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;

/**
 * 包: com.transing.crawl.web.controller
 * 源文件:ReleaseDataSourceTest.java
 *
 * @author Allen  Copyright 2016 成都创行, Inc. All rights reserved.2017年07月06日
 */
public class ReleaseDataSourceTest extends AbstractSpringBaseControllerTest
{
    @Test
    public void releaseDataSourceTest() throws Exception{
        String url="/synchronous/releaseDatasource.json";
        String jsonParam="{\"storageTypeBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":22,\"month\":6,\"seconds\":41,\"time\":1499322161000,\"timezoneOffset\":-480,\"year\":117},\"id\":6,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":6,\"month\":6,\"seconds\":15,\"time\":1499328375000,\"timezoneOffset\":-480,\"year\":117},\"storageTypeName\":\"凤凰网\",\"storageTypeTable\":\"ifeng_news\"}],\"storageTypeFieldBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":23,\"month\":6,\"seconds\":20,\"time\":1499322200000,\"timezoneOffset\":-480,\"year\":117},\"decimalLength\":0,\"fieldCnName\":\"标题\",\"fieldDesc\":\"标题\",\"fieldEnName\":\"title\",\"fieldLength\":100,\"fieldType\":\"2\",\"id\":7,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":23,\"month\":6,\"seconds\":20,\"time\":1499322200000,\"timezoneOffset\":-480,\"year\":117},\"storageTypeId\":6},{\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":24,\"month\":6,\"seconds\":46,\"time\":1499322286000,\"timezoneOffset\":-480,\"year\":117},\"decimalLength\":0,\"fieldCnName\":\"摘要\",\"fieldDesc\":\"摘要\",\"fieldEnName\":\"summary\",\"fieldLength\":500,\"fieldType\":\"2\",\"id\":8,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":24,\"month\":6,\"seconds\":46,\"time\":1499322286000,\"timezoneOffset\":-480,\"year\":117},\"storageTypeId\":6}],\"datasourceTypeBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":25,\"month\":6,\"seconds\":49,\"time\":1499322349000,\"timezoneOffset\":-480,\"year\":117},\"datasourceId\":8,\"datasourceTypeName\":\"凤凰咨询\",\"id\":6,\"isNeedLogin\":0,\"isNeedProxyIp\":0,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":6,\"month\":6,\"seconds\":36,\"time\":1499328396000,\"timezoneOffset\":-480,\"year\":117},\"storageTypeId\":6}],\"crawlRuleBos\":[{\"crawlUrl\":\"http://search.ifeng.com/sofeng/search.action?q=@keyword@&c=1&chel=&p=@page@\",\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":25,\"month\":6,\"seconds\":49,\"time\":1499322349000,\"timezoneOffset\":-480,\"year\":117},\"datasourceId\":8,\"datasourceTypeId\":6,\"id\":6,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"requestEncoding\":\"UTF-8\",\"requestMethod\":\"GET\",\"responseEncoding\":\"UTF-8\",\"ruleName\":\"凤凰咨询搜索_抓取规则\",\"testUrl\":\"http://search.ifeng.com/sofeng/search.action?q=%E6%9A%B4%E9%9B%A8&c=1&chel=\",\"crawlRuleRequestParamBos\":[],\"crawlRuleRequestHeaderBos\":[{\"crawlRuleId\":6,\"createTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":4,\"month\":6,\"seconds\":22,\"time\":1499328262000,\"timezoneOffset\":-480,\"year\":117},\"headerName\":\"Cookie\",\"headerType\":2,\"headerValue\":\"BIDUPSID=C812FE8C98CFA9D62E35FDA449E3BDAD; PSTM=1495788252; Hm_lvt_407473d433e871de861cf818aa1405a1=1495848370,1496192722,1497315505,1497402961; MCITY=-%3A; BDORZ=B490B5EBF6F3CD402E515D22BCDA1598; Hm_lvt_e9e114d958ea263de46e080563e254c4=1498532428,1498635297,1499322158,1499322577; Hm_lpvt_e9e114d958ea263de46e080563e254c4=1499322577; BDRCVFR[C0p6oIjvx-c]=mk3SLVN4HKm; BD_CK_SAM=1; PSINO=3; BDSVRTM=134; H_PS_PSSID=; BAIDUID=C9F2FB9AC80B13F65D5178430B858442:FG=1; LOCALGX=%u6210%u90FD%7C%36%36%39%33%7C%u6210%u90FD%7C%36%36%39%33\",\"id\":5,\"inputType\":1,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":4,\"month\":6,\"seconds\":22,\"time\":1499328262000,\"timezoneOffset\":-480,\"year\":117},\"crawlRuleRequestHeaderSuffProcBos\":[]}],\"crawlRulePageBo\":{\"calculation\":1,\"crawlRuleId\":6,\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":29,\"month\":6,\"seconds\":48,\"time\":1499322588000,\"timezoneOffset\":-480,\"year\":117},\"endPage\":10,\"endPageIdentifier\":\"\",\"endPageSimilarity\":0,\"firstUrl\":\"http://search.ifeng.com/sofeng/search.action?q=@keyword@&c=1&chel=\",\"fomat\":\"0\",\"formatType\":1,\"id\":3,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"maxPage\":0,\"pageSize\":20,\"startPage\":1,\"stepLength\":1,\"crawlRulePageParseBos\":[{\"crawlRulePageId\":3,\"createTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"id\":1,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"parseExpression\":\"//span[@class=\\\"nums\\\"]/text()\",\"parseType\":1}],\"crawlRulePageSuffProcBos\":[{\"crawlRulePageId\":3,\"createTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"id\":1,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":12,\"month\":6,\"seconds\":33,\"time\":1499328753000,\"timezoneOffset\":-480,\"year\":117},\"processorId\":1,\"processorValue\":\".*(\\\\d+).*?(\\\\d+).*\"}]}}],\"crawlRuleDetailBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":15,\"minutes\":15,\"month\":6,\"seconds\":50,\"time\":1499325350000,\"timezoneOffset\":-480,\"year\":117},\"detailName\":\"凤凰咨询列表规则2\",\"id\":5,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":16,\"month\":6,\"seconds\":48,\"time\":1499329008000,\"timezoneOffset\":-480,\"year\":117},\"pageType\":1,\"ruleId\":6,\"status\":1,\"crawlRuleDetailPreProcBos\":[],\"crawlRuleDetailParseBos\":[{\"crawlRuleDetailId\":5,\"createTime\":{\"date\":6,\"day\":4,\"hours\":15,\"minutes\":15,\"month\":6,\"seconds\":50,\"time\":1499325350000,\"timezoneOffset\":-480,\"year\":117},\"id\":3,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":16,\"month\":6,\"seconds\":48,\"time\":1499329008000,\"timezoneOffset\":-480,\"year\":117},\"parseExpression\":\"//div[@class=\\\"searchResults\\\"]\",\"parseType\":1}],\"crawlRuleDetailSuffProcBos\":[],\"crawlRuleDetailFieldBos\":[{\"crawlRuleDetailId\":5,\"id\":15,\"ruleId\":6,\"storageTypeFieldId\":7,\"crawlRuleDetailFieldParseBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":15,\"minutes\":15,\"month\":6,\"seconds\":50,\"time\":1499325350000,\"timezoneOffset\":-480,\"year\":117},\"detailFieldId\":15,\"id\":2,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":16,\"month\":6,\"seconds\":48,\"time\":1499329008000,\"timezoneOffset\":-480,\"year\":117},\"parseExpression\":\"//p[1]/a//text()\",\"parseType\":1}],\"crawlRuleDetailFieldSuffProcBOs\":[]},{\"crawlRuleDetailId\":5,\"id\":16,\"ruleId\":6,\"storageTypeFieldId\":8,\"crawlRuleDetailFieldParseBos\":[{\"createTime\":{\"date\":6,\"day\":4,\"hours\":15,\"minutes\":15,\"month\":6,\"seconds\":50,\"time\":1499325350000,\"timezoneOffset\":-480,\"year\":117},\"detailFieldId\":16,\"id\":3,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":16,\"minutes\":16,\"month\":6,\"seconds\":48,\"time\":1499329008000,\"timezoneOffset\":-480,\"year\":117},\"parseExpression\":\"//p[2]//text()\",\"parseType\":1}],\"crawlRuleDetailFieldSuffProcBOs\":[]}]}],\"crawlInputParamBos\":[{\"datasourceId\":8,\"datasourceTypeId\":6,\"id\":11,\"isRequired\":\"0\",\"paramCnName\":\"关键词\",\"paramEnName\":\"keyword\",\"prompt\":\"请输入关键词\",\"restrictions\":\" \",\"styleId\":1}],\"datasourceBo\":{\"createTime\":{\"date\":6,\"day\":4,\"hours\":14,\"minutes\":25,\"month\":6,\"seconds\":11,\"time\":1499322311000,\"timezoneOffset\":-480,\"year\":117},\"datasourceName\":\"凤凰\",\"id\":8,\"isNeedLogin\":0,\"isNeedProxyIp\":0,\"lastmodifyTime\":{\"date\":6,\"day\":4,\"hours\":18,\"minutes\":27,\"month\":6,\"seconds\":11,\"time\":1499336831000,\"timezoneOffset\":-480,\"year\":117},\"loginClazz\":\"\",\"status\":3}}";
        MvcResult mvcResult=this.mockMvc.perform(MockMvcRequestBuilders.post(url).param("datasourceParam",jsonParam)).andDo(print()).andExpect(status().isOk()).andReturn();
        String content=mvcResult.getResponse().getContentAsString();
        assertTrue(com.jeeframework.util.json.JSONUtils.isJSONValid(content));
        assertTrue(JSONObject.fromObject(content).getInt("code")==0);
    }
}
